var path = require('path');
const chalk = require("chalk");
var myIp = require('my-ip')();
var url = require("url");

module.exports = function(options){
	var express = require('express');
	var app = express();
	var port = 3000;

	if(options.port){
		port = options.port
	}

	var server = require('http').createServer(app);
	var io = require("socket.io")(server);

	var room = "";

	io.on("connection",function(socket){
		socket.emit('open');
		socket.on("setDebug",function(data){
			room = data.room;
		});
		socket.on("subscribe",function(data){
			socket.join(data.room);
		});
		socket.on("unsubscribe",function(data){
			socket.leave(data.room);
		});
		socket.on("requestAction",function(data){
			socket.broadcast.to(room).emit("responseAction",data);
		});
		socket.on("requestState",function(data){
			socket.broadcast.to(room).emit("responseState",data);
		});
	});

	server.listen(port, function(error){
		if(error){
			console.log(chalk.red(error));
		}else {
			console.log(chalk.green("==> 🌎  Listening on port "+port+". Open up http://"+myIp+":"+port+"/ in your browser."));
			console.log(chalk.green("==> 🌎  已开启socket server 调试模式"));
		}
	});
}



